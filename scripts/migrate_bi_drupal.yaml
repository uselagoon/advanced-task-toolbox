steps:
  - name: Scale up cli deployment
    type: scale
    deployment: cli
  - name: copy lagoon sync to cli pod
    type: copyto
    deployment: cli
    source: /usr/bin/lagoon-sync
    destination: /tmp/lagoon-sync-migrate
  - name: copy lagoon sync config to cli pod
    type: copyto
    deployment: cli
    source: ./scripts/migrate_bi_drupal/lagoon-sync.yml
    destination: /tmp/lagoon-sync-migrate.yml
  - name: Change deploy target
    type: setdeploytarget
    target: 157
  - name: Deploy
    type: deploy
    passIfTextExistsInLogs:
  - name: Copy Database
    type: exec
    local: true
    command: cp /var/run/secrets/lagoon/ssh/ssh-privatekey /tmp/ssh-privatekey && chmod 600 /tmp/ssh-privatekey && lagoon-sync sync mariadb --config=./scripts/migrate_bi_drupal/lagoon-sync.yml -p %project% -t %environment% -e local --ssh-key=/tmp/ssh-privatekey --no-interaction --verbose
  - name: Run lagoon-sync on files
    type: exec
    deployment: cli
    command: /tmp/lagoon-sync-migrate sync files --config=/tmp/lagoon-sync-migrate.yml -p %project% -t %environment% -e local --no-interaction --verbose

rollback:
  - name: Reset deploy target back to current
    type: setdeploytarget
    target: 143
  - name: Deploy
    type: deploy